let visited = new Set();

const myOnMessage = e => {
    let data = JSON.parse(e.data);

    if (data.start) {
        let X = Math.floor(Math.random() * 14);
        let Y = Math.floor(Math.random() * 14);
        let Z = Math.floor(Math.random() * 10);
        socket.send(JSON.stringify({"event": "click", "x": X, "y": Y, "z": Z}));
    }
    
    if (data.update) {
        data.update.forEach(upd => {
            if (upd.state == "bomb") {
                window.location.reload();
            }

            if (upd.state == "open" && upd.count == 0) {
                for (let dx = -1; dx <= 1; ++dx) {
                for (let dy = -1; dy <= 1; ++dy) {
                for (let dz = -1; dz <= 1; ++dz) {
                    let X = upd.x + dx;
                    let Y = upd.y + dy;
                    let Z = upd.z + dz;
                    if ((dx || dy || dz) && X >= 0 && Y >= 0 && Z >= 0 && X <= 13 && Y <= 13 && Z <= 9) {
                        let setKey = `${X},${Y},${Z}`;
                        if (!visited.has(setKey)) {
                            socket.send(JSON.stringify({"event": "click", "x": X, "y": Y, "z": Z}));
                            visited.add(setKey);
                        }
                    }
                }
                }
                }
            }
        });
    }

    onMessage(e);
}

window.addEventListener("load", e => {
    socket.onmessage = myOnMessage;
});

window.setTimeout(() => {
    if (visited.size < 50) {
        window.location.reload();
    }
}, 3000);
